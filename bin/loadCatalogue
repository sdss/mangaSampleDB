#!/usr/bin/env python
# encoding: utf-8
"""
loadCatalogueToSampleDB

Created by José Sánchez-Gallego on 23 Jul 2015.
Licensed under a 3-clause BSD license.

Revision history:
    23 Jul 2015 J. Sánchez-Gallego
      Initial version
    18 Feb 2016 J. Sánchez-Gallego
      Moved to new product ands restructured.
      Made functional.

"""

from __future__ import division
from __future__ import print_function
from mangaSampleDB.utils.catalogue import ingestCatalogue
import argparse
import sys
import os


def main(argv=None):

    parser = argparse.ArgumentParser(prog=os.path.basename(sys.argv[0]))

    parser.add_argument('--connection-string', type=str, dest='connString',
                        help='The connection string to be used when calling '
                             'DatabaseConnection. If not defined, the default '
                             'connection was not used.')

    subparsers = parser.add_subparsers(title='actions')

    # parserTest = subparsers.add_parser(
    #     'test', help='runs the test suite', description='Runs the test suite.')
    # parserTest.set_defaults(func=runTests)

    parserIngest = subparsers.add_parser(
        'ingest', help='loads a catalogue in mangaSampleDB',
        description='Loads a catalogue in mangaSampleDB.')
    parserIngest.add_argument('CATFILE', metavar='CATFILE', type=str,
                              help='The file with the catalogue to load')
    parserIngest.add_argument('CATNAME', metavar='CATNAME', type=str,
                              help='The name for this catalogue')
    parserIngest.add_argument('VERSION', metavar='VERSION', type=str,
                              help='The version of the catalogue being loaded')
    parserIngest.add_argument('-c', '--current', dest='current',
                              action='store_true',
                              help='Makes the catalogue being loaded the '
                                   'current version.')
    parserIngest.add_argument('-r', '--replace', dest='replace',
                              action='store_true',
                              help='If the catalogue-version exists, '
                              'removes its recodes before ingesting.')
    parserIngest.add_argument('-m', '--match', dest='match', type=str,
                              action='store', nargs=2,
                              metavar=('MATCH_FILE', 'MATCH_DESCRIPTION'),
                              help='The file containing the matching between '
                                   'mangaids and the catalogue being loaded '
                                   'and the file with the description on how '
                                   'the matching was performed.')
    parserIngest.set_defaults(func=ingestCatalogue)

    args = parser.parse_args()

    funcKwargs = {}
    for key in vars(args).keys():
        funcKwargs[key.lower()] = getattr(args, key)

    args.func(**funcKwargs)


if __name__ == '__main__':
    main()
